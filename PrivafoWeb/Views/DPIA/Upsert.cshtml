@model Privafo.Models.ViewModels.DPIAVM
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager


<form method="post" asp-action="Upsert" enctype="multipart/form-data">
		<input asp-for="DPIATemplate.ID" hidden />
        <input asp-for="DPIATemplate.CreatedBy" value="@UserManager.GetUserId(User)" hidden />
			<div class="row">
				<div class="col-12">            
					<div class="col-12 pb-2">
						<h2 class="text-primary">@(Model.DPIATemplate.ID!=0?"Update": "Create") Template</h2>
@*						<div class="ms-auto">
							<div class="row gy-3">
								<div class="col-md-10">
								<input id="todo-input" type="text" class="form-control" value="">
								</div>
								<div class="col-md-2 text-end d-grid">
								<button type="button" onclick="CreateTodo();" class="btn btn-primary">Add Section</button>
								</div>
							</div>			
						</div>*@
					</div>   
				</div>

				<div class="accordion" id="accordionHeader">
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingOneHeader">
						<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
							<strong>Header</strong>
						</button>
					</h2>

					<div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionHeader">
						<div class="accordion-body">	
								<div class="mb-3">
                                    <label asp-for="DPIATemplate.TemplateName">Template Name</label>
                                    <input id="tmpname" asp-for="DPIATemplate.TemplateName" class="form-control" />
                                    <span asp-validation-for="DPIATemplate.TemplateName" class=text-danger></span>
								</div>
								<div class="mb-3">
                                    <label asp-for="DPIATemplate.Description"></label>
                                    <textarea asp-for="DPIATemplate.Description" class="form-control" rows=3></textarea>
                                    <span class=text-danger></span>
								</div>
                                <div class="mb-3">
                                    <label asp-for="DPIATemplate.Icon" hidden></label>
                                    <textarea asp-for="DPIATemplate.Icon" rows=3 class="form-control" hidden></textarea>                    
                                </div>
                                    <div class="mb-3">
                                    <label asp-for="DPIATemplate.Welcome"></label>
                                    <textarea id="welcome" asp-for="DPIATemplate.Welcome" class="form-control" rows=3></textarea>
                                    <span class=text-danger></span>
                                </div>  
                        </div>
					</div>
				</div>				
				</div>  
                <br />
						<div class="ms-auto">
							<div class="row gy-3">
								<div class="col-md-12 text-end">
									<button class="btn btn-primary"  type="button" onclick="TampilModalSection();" data-bs-toggle="modal"  data-bs-target="#sectionModal">Add Section</button>
								</div>
							</div>			
						</div>                        
                <div class="form-row mt-3">
							<div class="col-12">
								<div id="todo-container"></div>
							</div>
				</div> 
			</div>

			<div class="modal fade" id="sectionModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalLabel">Add New Section</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div class="row">
							<div class="col-12"> 
								<div class="mb-3">
									<label>Section Name</label>
								</div>
								<div class="mb-3">
									<input id="todo-input" type="text" class="form-control" required>
								</div>
							</div>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary" onclick="CreateTodo();">Add</button> 
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
						</div>
					</div>

				</div>
			</div>

			<div class="modal fade" id="mainModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalLabel">Add New Question</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
					<div class="modal-body">
						<input asp-for="DPIATemplate.ID" hidden />
						<input asp-for="DPIATemplate.CreatedBy" value="@UserManager.(User)" hidden />
					<div class="row">
					<div class="col-12">       
							<div class="mb-3">	
								<span id="section_id" hidden></span>
								<span id="section"></span>
							</div>					
							<div class="mb-3">
								<label>Question</label>
								<textarea id="idquestion" class="form-control" rows=2 required></textarea>
							</div>
							<div class="mb-3">
								<label>Friendly Name</label>
								<input class="form-control" id="idfriendly" />
							</div>
							 <div class="mb-3">
								<label>Description</label>
								<textarea class="form-control" rows=2></textarea>
							</div>  
							<div class="mb-3">
										<label class="form-label">Type</label>
										<select class="single-select">
											<option value="mc">Multi Choice</option>
											<option value="yn">Yes / No</option>
											<option value="tx">Text</option>
											<option value="dt">Date</option>
											<option value="st">Statement</option>
											<option value="in">Inventory</option>
											<option value="pd">Personal Data</option>
											<option value="ac">Access Control</option>
										</select>
							</div>
					</div>
						<div class="mb-3">
							<table style="vertical-align:top; width:100%">
								<tr>
									<td>
                                				<label class="form-label">Question Configuration</label>
												<div class="form-check form-switch">
													<input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked" checked>
													<label class="form-check-label" for="flexSwitchCheckChecked">Answer Required</label>
												</div>
												<div class="form-check form-switch">
													<input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked">
													<label class="form-check-label" for="flexSwitchCheckChecked">Attachment Required</label>
												</div>
												<div class="form-check form-switch">
													<input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked">
													<label class="form-check-label" for="flexSwitchCheckChecked">Question Hint</label>
												</div>
									</td>
									<td></td>
									<td>
                                				<label class="form-label">Response Configuration</label>
												<div class="form-check form-switch">
													<input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked">
													<label class="form-check-label" for="flexSwitchCheckChecked">Allow Not Sure</label>
												</div>
												<div class="form-check form-switch">
													<input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked">
													<label class="form-check-label" for="flexSwitchCheckChecked">Allow Not Applicable</label>
												</div>
												<div class="form-check form-switch">									        
												</div>
									</td>
								</tr>
							</table>
						</div>
						<div class="mb-3">
							<label for="formFileMultiple" class="form-label">Upload Attachment (Max 256 MB)</label>
							<input class="form-control" type="file" id="formFileMultiple" multiple>
						</div>
					</div>
					</div>
					  <div class="modal-footer">
						<button type="button" class="btn btn-primary" onclick="productUpdate();">Add</button> 
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					  </div>
					</div>

				</div>
			</div>

</form>




@*Validate in Client Side*@
@section Scripts{
    @{
        <partial name="_ValidationScriptsPartial"></partial>
    }
}

	<script src="~/theme/js/app.js"></script>



	<script>
		function TampilModalSection(param)
		{
			document.getElementById("todo-input").value = '';
		}
		function TampilModal(param)
		{
			var paramid = param.id;
			document.getElementById("section_id").innerHTML = paramid;
			document.getElementById("section").innerHTML = "Section : " + document.getElementById(paramid + "_SecName").value;
		}

		// to do list 
		 var todos = [{
			text: "",
			done: false,
			id: 0
		}];
		var currentTodo = {
			text: "",
			done: false,
			id: 0
		}
		document.getElementById("todo-input").oninput = function (e) {
			currentTodo.text = e.target.value;
		};

		function DrawTodo(todo) {
			var newTodoHTML = `
			<div class="pb-3 todo-item" todo-id="${todo.id}">
						<div class="input-group">					
							<div class="input-group-text">
								<label>Section #${todo.id}</label>							
							</div>
							<input type="text" id="${todo.id}_SecName" class="form-control ${todo.done&&" todo-done"} " aria-label="Text input with checkbox" value="${todo.text}" readonly>
							<button class="btn btn-outline-secondary" id="${todo.id}"  data-activecontainer="${todo.id}_quest" type="button" data-bs-toggle="modal" onclick="TampilModal(this);" data-bs-target="#mainModal">Add Question</button>
							<button todo-id="${todo.id}" class="btn btn-outline-secondary bg-danger text-white" type="button" onclick="DeleteTodo(this);" id="button-addon2 ">X</button>
							<div class="container">
							 <div class="row">
									<div>
									<br>
										<h6>Question List</h6>
									</div>
							 </div>
							 <div class="row">
								<div class="col-sm-12">
									<table id="${todo.id}_productTable" class="table table-bordered table-condensed table-striped">
										<thead>
											<tr>
												<th>ID</th>
												<th>Question</th>
												<th>Friendly</th>
											</tr>
										</thead>
									</table>
								</div>
							</div>
							</div>								
						</div>
			</div>

			  `;
			var dummy = document.createElement("DIV");
			if (todo.id == 0)
			{
				newTodoHTML = `
				<div class="pb-3 todo-item" todo-id="${todo.id}">
				</div>
				`;
			}
			dummy.innerHTML = newTodoHTML;
			document.getElementById("todo-container").appendChild(dummy.children[0]);
		}

		function RenderAllTodos() {
			var container = document.getElementById("todo-container");
			while (container.firstChild) {
				container.removeChild(container.firstChild);
			}

			for (var i = 0; i < todos.length; i++) {
				DrawTodo(todos[i]);
			}
		}
		RenderAllTodos();

		function DeleteTodo(button) {
			var deleteID = parseInt(button.getAttribute("todo-id"));

			for (let i = 0; i < todos.length; i++) {
				if (todos[i].id === deleteID) {
					todos.splice(i, 1);
					RenderAllTodos();
					break;
				}
			}
		}

		function TodoChecked(id) {
			todos[id].done = !todos[id].done;
			RenderAllTodos();
		}

		function CreateTodo() {
			//alert (currentTodo.text);
			$("#sectionModal").modal("hide");
			if (currentTodo.text.trim().length == 0)
			{
			 return;
			}
			newtodo = {
				text: currentTodo.text,
				done: false,
				id: todos.length
			}
			todos.push(newtodo);
			currentTodo.text = '';
			RenderAllTodos();
		}
	</script>




<script>
    function productUpdate() 
	{
		$("#mainModal").modal("hide");
		if ($("#idquestion").val() != null && $("#idquestion").val() != '') 
		{
			productAddToTable();
			formClear();
			$("#question").focus();
		}
	}

	function productAddToTable() 
	{
		
		var idx = document.getElementById("section_id").innerHTML;
		//alert(idx);
		if ($("#" + idx + "_productTable" + " tbody").length == 0) 
		{
			$("#" + idx + "_productTable" + "").append("<tbody></tbody>");
		}

		$("#" + idx + "_productTable" + " tbody").append("<tr>" +
        "<td>" + $("#section_id").val() + "</td>" +
        "<td>" + $("#idquestion").val() + "</td>" +
        "<td>" + $("#idfriendly").val() + "</td>" +
        "</tr>");
	}

	function formClear() 
	{
		$("#idquestion").val("");
		$("#idfriendly").val("");
	}
</script>


@*<script>
// data-* attributes to scan when populating modal values
var ATTRIBUTES = ['activecontainer'];

$('[data-toggle="modal"]').on('click', function (e) {
  // convert target (e.g. the button) to jquery object
  var $target = $(e.target);
  // modal targeted by the button
  var modalSelector = $target.data('target');
  
  // iterate over each possible data-* attribute
  ATTRIBUTES.forEach(function (attributeName) {
    // retrieve the dom element corresponding to current attribute
    var $modalAttribute = $(modalSelector + ' #modal-' + attributeName);
    var dataValue = $target.data(attributeName);
    
    // if the attribute value is empty, $target.data() will return undefined.
    // In JS boolean expressions return operands and are not coerced into
    // booleans. That way is dataValue is undefined, the left part of the following
    // Boolean expression evaluate to false and the empty string will be returned
    $modalAttribute.text(dataValue || '');
  });
});	
	</script>*@